{% extends 'base.html' %}

{% load widget_tweaks %}
{% load static %}
{% load dict_tags %}

{% block own_css %}{% endblock %}
{% block title %}
    <title>Арматурная карточка</title>
{% endblock %}


{% block content %}
    <div class="container">
        <br>

        <br>

        <h3>Движение материальных средств - <span class="fst-italic">{{ card.employee.get_full_name }}</span></h3><br>


        <form id="clothes_in_card_form">{% csrf_token %}
            <input type="hidden" value="{{ card.id }}" id="id_card">
            <div class="row align-items-end">
                <div class="col-lg-3">
                    <div class="mb-3">
                        <label class="form-label">Наименование</label>
                        <select name="clothes" class="form-select my-select2" id="id_clothes" required multiple>
                            <option value="">-----</option>
                            {% for clothes in clothes_list_full %}
                                <option value="{{ clothes.id }}">{{ clothes.clothes_title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="mb-3">
                        <label class="form-label">Количество</label>
                        <input type="number" class="form-control" id="id_count_of_issue" required>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="mb-3">
                        <label class="form-label">Дата выдачи</label>
                        <input type="date" class="form-control" id="id_date_of_issue" required>
                    </div>
                </div>

                <div class="col-lg-3">
                    <div class="mb-3">
                        <button type="submit" class="btn btn-secondary" id="add_clothes_in_card_button">Добавить
                        </button>
                    </div>
                </div>
            </div>
        </form>

        {% if clothes_list %}
            {% for id in list_of_clothes_id %}
                {% with clothes=clothes_list|get_clothes:id %}
                    <h5>Наименование - <span class="fst-italic">{{ clothes.clothes_title }}</span>,</h5>
                    <h5>Номенклатура - <span class="fst-italic">{{ clothes.nomenclature }}</span>,</h5>
                    <h5>Срок носки - <span class="fst-italic">{{ clothes.wear_time }} мес.</span></h5>
                {% endwith %}

                {% with issues=clothes_list|get_issues_dates:id %}
                    {% for item in issues %}
                        {{ item.date_of_issue }} {{ item.count }} шт. <a href="javascript:delete_clothes_in_card({{ item.id }})">удалить</a>
                        <br>
                    {% endfor %}<br>
                {% endwith %}
            {% endfor %}

        {% else %}
            <p>Список пуст!</p>
        {% endif %}


    </div>
{% endblock %}


{% block own_js %}

    <script>
        $('#clothes_in_card_form').submit(function (e) {
            e.preventDefault();
            let csrftoken = $("input[name='csrfmiddlewaretoken']").val();

            let ids_array = $('#id_clothes').val();

            let requests = []
            ids_array.map(id => {
                let new_obj = {
                    'card': $('#id_card').val(),
                    'clothes': id,
                    'count': $('#id_count_of_issue').val(),
                    'date_of_issue': $('#id_date_of_issue').val()
                }

                requests.push(
                    fetch('/api/clothes-in-card/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8',
                            "X-CSRFToken": csrftoken,
                        },
                        body: JSON.stringify(new_obj)
                    })
                )
            })

            Promise.all(requests).then(() => {
                window.location.href = window.location.href
            }).catch((e) => alert(e.message))
        });

        function delete_clothes_in_card(id) {
            csrftoken = $("input[name='csrfmiddlewaretoken']").val();
            fetch(`/api/clothes-in-card/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8',
                    "X-CSRFToken": csrftoken,
                },
            }).then(response => {
                    if (response.status >= 200 && response.status < 300) {
                        window.location.href = window.location.href
                    } else {
                        throw new Error("Ошибка удаления!")
                    }
                }
            ).catch((e) => alert(e.message))
        }

    </script>

{% endblock %}

